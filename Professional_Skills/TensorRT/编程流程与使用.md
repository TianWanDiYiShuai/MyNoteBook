# 第四章：编程流程与使用

## 1、“.pd”冻结图文件转换为UFF文件

  在TensorRT的环境配置中需要注意cuda、cudnn、TensorRT的版本对应匹配关系，在最新的TensorRT5.1.2的版本中，最低支持cudnn的版本为7.5.0，cuda版本没有试过但是cuda10比较好。

对于使用的Tensorflow版本，新的Tensorflow2.0版本还不能很好的支持pd文件转uff文件，所以需要安装Tensorflow1版本。

* **获取convert-to-uff文件路径**

  ```
  # 获取which convert-to-uff路径
  # 其路径的一般位置为对于python2 /usr/lib/python2.7/dist-packages/uff/bin/convert_to_uff.py,
  # 对于python3 /usr/lib/python3.6/dist-packages/uff/bin/convert_to_uff.py,
  # 对于使用conda创建的虚拟环境：~/.conda/envs/TensorRT/bin/convert-to-uff
  which convert-to-uff
  ```

* **.pb冻结图**

  * pd冻结图的生成

    ```python
    from keras.models import load_model
    import keras.backend as K
    from tensorflow.python.framework import graph_io
    from tensorflow.python.tools import freeze_graph
    from tensorflow.core.protobuf import saver_pb2
    from tensorflow.python.training import saver as saver_lib
    
    def convert_keras_to_pb(keras_model, out_names, models_dir, model_filename):
        model = load_model(keras_model)
        K.set_learning_phase(0)
        sess = K.get_session()
        saver = saver_lib.Saver(write_version=saver_pb2.SaverDef.V2)
        checkpoint_path = saver.save(sess, 'saved_ckpt', global_step=0, latest_filename='checkpoint_state')
        graph_io.write_graph(sess.graph, '.', 'tmp.pb')
        freeze_graph.freeze_graph('./tmp.pb', '',
                                  False, checkpoint_path, out_names,
                                  "save/restore_all", "save/Const:0",
                                  models_dir+model_filename, False, "")
    ```

    [tensorflow冻结图官方文档](https://www.tensorflow.org/guide/extend/model_files#freezing)

  * pd转换为uff

    ```
    convert-to-uff input_file [-o output_file] [-O output_node]
    ```

    ![](/Image/专业技能/TensorRT/convert-to-uff.png)

  - **设置config.py文件**
  - 

## 2、通过UFF文件构建推理器

## 3、部署推理器

## 4、效果测试



